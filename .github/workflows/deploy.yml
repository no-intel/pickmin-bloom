# ---------------------------------------
# GitHub Actions CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ë¸Œëœì¹˜: mainì— push ë˜ë©´ EC2ë¡œ ìë™ ë°°í¬
# ìˆ˜ë™ ì‹¤í–‰ë„ ì§€ì› (Run workflow ë²„íŠ¼)
# ---------------------------------------

name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜'
        default: 'main'
        required: true

  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“„ ë³€ê²½ íŒŒì¼ í™•ì¸
        id: file_check
        run: |
          echo "ğŸ“¦ Diff range: ${{ github.event.before }} â†’ ${{ github.sha }}"
          git fetch origin master
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ' ')
          echo "ë³€ê²½ íŒŒì¼ ëª©ë¡:"
          echo "$CHANGED"
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT

      - name: ğŸš« README.mdë§Œ ë³€ê²½ëœ ê²½ìš° ì¢…ë£Œ
        if: |
          steps.file_check.outputs.changed_files == 'README.md' ||
          (contains(steps.file_check.outputs.changed_files, 'README.md') && !contains(steps.file_check.outputs.changed_files, '.java') && !contains(steps.file_check.outputs.changed_files, '.yaml'))
        run: |
          echo "ğŸ›‘ README.mdë§Œ ë³€ê²½ë¨. ë°°í¬í•˜ì§€ ì•ŠìŒ."
          exit 0

      - name: âœ… gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ğŸ› ï¸ Gradle Build (No Tests)
        run: ./gradlew clean build -x test

      - name: ğŸšš EC2ì— JAR íŒŒì¼ ë³µì‚¬ (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "build/libs/app.jar"
          target: "/home/ec2-user/"

      - name: ğŸš€ EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            set -e
            cd ~
            mv ~/build/libs/app.jar ~/app.jar
            sudo chmod +x deploy.sh
            ./deploy.sh
