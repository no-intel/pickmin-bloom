# ---------------------------------------
# GitHub Actions CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ë¸Œëœì¹˜: mainì— push ë˜ë©´ EC2ë¡œ ìë™ ë°°í¬
# ---------------------------------------

name: Deploy to EC2

on:
  workflow_dispatch:                              # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜'
        default: 'main'
        required: true
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest                        # GitHubì´ ì œê³µí•˜ëŠ” Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (checkout)
        uses: actions/checkout@v3                 # í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ê°€ì ¸ì˜´

      - name: ğŸš€ EC2ì— ë°°í¬ (SSH ì ‘ì†)
        uses: appleboy/ssh-action@master           # SSHë¡œ ì›ê²© ì„œë²„ ëª…ë ¹ì–´ ì‹¤í–‰
        with:
          host: ${{ secrets.EC2_HOST }}            # EC2 í¼ë¸”ë¦­ IP or í˜¸ìŠ¤íŠ¸ë„¤ì„ (ë¹„ë°€ê°’)
          username: ec2-user                       # EC2 ê¸°ë³¸ ì‚¬ìš©ì (Amazon Linux ê¸°ì¤€)
          key: ${{ secrets.EC2_PRIVATE_KEY }}      # PEM í‚¤ ë‚´ìš© (ë¹„ë°€ê°’)
          script: |
            cd ~                                    # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            rm -f app.jar                           # ê¸°ì¡´ JAR ì‚­ì œ
            wget https://github.com/no-intel/pickmin-bloom/releases/latest/download/app.jar -O app.jar
            sudo chmod +x deploy.sh                      # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            ./deploy.sh                             # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
