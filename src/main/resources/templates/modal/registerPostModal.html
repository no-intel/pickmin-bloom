<div class="modal fade" id="register-post-modal" tabindex="-1" role="dialog" aria-labelledby="엽서 등록 신청"
     aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">엽서 등록 신청</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-6 d-none d-lg-block bg-login-image">
                            <img src="/img/post-register.png" alt="register-post-image" style="max-width: 100%; height: auto;">
                        </div>
                        <div class="col-lg-6">
                            <label for="post-name">엽서 이름</label>
                            <input type="text" class="form-control" id="post-name" placeholder="엽서 이름">
                            <label for="post-latitude">위도(구글 좌표 기준 왼쪽)</label>
                            <input type="number" class="form-control" id="post-latitude" placeholder="32.22222">
                            <label for="post-longitude">경도(구글 좌표 기준 오른쪽)</label>
                            <input type="number" class="form-control" id="post-longitude" placeholder="127.22222">
                            <label for="post-type">엽서 구분</label>
                            <div class="dropdown mb-4">
                                <select class="form-select" aria-label="Default select example" id="post-type">
                                    <option selected value="null">구분</option>
                                    <option value="버섯">버섯</option>
                                    <option value="빅플">빅플</option>
                                    <option value="탐험">탐험</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="post-img" class="form-label">엽서 이미지 업로드</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" id="post-img" accept="image/*">
                                    <label class="input-group-text" for="post-img">Upload</label>
                                </div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="no-img">
                                <label class="form-check-label" for="no-img">이미지 없음</label>
                            </div>
                            <a class="btn btn-primary btn-user btn-block" onclick="registerPost()">
                                등록 신청
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal" onclick="closeModal()" id="register-post-modal-close-btn">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script>
    async function registerPost() {
        const postName = document.getElementById('post-name').value;
        const postLat = document.getElementById('post-latitude').value;
        const postLon = document.getElementById('post-longitude').value;
        const postImg = document.getElementById('post-img').files[0];
        const noImg = document.getElementById('no-img').checked;
        const postType = document.getElementById('post-type').value;

        try {
            const formData = new FormData();
            formData.append('postName', postName);
            formData.append('postLat', postLat);
            formData.append('postLon', postLon);
            formData.append('noImg', noImg);
            formData.append('postType', postType);
            if (!noImg && postImg) {
                formData.append('postImg', postImg);
            }

            if (!vaildation(formData)){
                throw new Error("엽서 신청에 필요한 조건을 만족하지 못했습니다.");
            }

            const response = await fetch('/pre-posts', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            if (!response.ok) {
                const result = await response.json();
                alert(result.message);
                return;
            }

            document.getElementById('register-post-modal-close-btn').click();
            alert("등록 신청이 완료 됐습니다.")
            return null;

        } catch (error) {
            console.error('Error:', error);
        }
    }
    function vaildation(formData) {
        if (!formData.get('postName') || formData.get('postName').trim() === "") {
            alert("엽서 이름은 필수입니다!")
            return false;
        }

        if (!formData.get('postLat') || isNaN(formData.get('postLat'))) {
            alert("위도를 입력하세요!")
            return false;
        }

        if (!formData.get('postLon') || isNaN(formData.get('postLon'))) {
            alert("경도를 입력하세요!")
            return false;
        }

        const postType = formData.get('postType');
        const validPostTypes = ["탐험", "버섯", "빅플"];
        if (!validPostTypes.includes(postType)) {
            alert("엽서 구분은 '탐험', '버섯', '빅플' 중 하나여야 합니다!")
            return false;
        }

        const noImg = formData.get('noImg') === "true" || formData.get('noImg') === true;
        if (!noImg) {
            const postImg = formData.get('postImg');
            if (!postImg || !(postImg instanceof File)) {
                alert("이미지를 업로드해 주세요!")
                return false;
            }

            const allowedExtensions = ["image/jpeg", "image/png", "image/jpg"];
            if (!allowedExtensions.includes(postImg.type)) {
                alert("JPEG, JPG, PNG 형식의 이미지 파일만 가능합니다.")
                return false;
            }
        }
        return true;
    }

    function closeModal() {
        document.getElementById('post-name').value = '';
        document.getElementById('post-latitude').value = '';
        document.getElementById('post-longitude').value = '';
        document.getElementById('post-img').value = '';
        document.getElementById('no-img').checked = false;
        document.getElementById('post-type').value = 'null';

        const modal = document.getElementById('register-post-modal');
        const bootstrapModal = bootstrap.Modal.getInstance(modal) || new bootstrap.Modal(modal);
        bootstrapModal.hide();
    }
</script>